---
title: "Forecasting Chicago Divvy Bike Ridership"
author: "Keith Hultman"
date: "April 22, 2017"
output: html_notebook
---

## Introduction

Divvy is a bike sharing system for the city of Chicago that provides residents and tourists an option for getting around the city. After patrons purchase a daily or annual pass, they can unlock a bike, ride to their destination, and return the bike to one of the Divvy bike docking stations found throughout the city. The daily and annual pass includes 30 minutes of riding time, with additional fees for longer trips. The program is designed to promote short one-way trips to increase sharing of the bikes throughout the day. 

The ability to forecast Divvy bike use would be beneficial for the following reasons

1. Forecasting into the next season would allow for the Divvy program to plan on future expansion or price changes to opimize bike use or profitability.
2. On a granular level, identifying the patterns of use for each bike station would allow the Divvy program to opimize bike placement and availability. Stations that are predicted to have increasing use can be expanded for additional Divvy bike slots, and it may be necessary to transport bikes from one station to another.
3. The Divvy program can be used as a measure of transportation activity in the city and can be a measure for identifying how people move about the city on a day-to-day and week-to-week basis. 

## Exploring the Divvy data

I will first try to model the daily duration of Divvy rides for all bike stations in the city. The data was collected from the [City of Chicago Data Portal](https://data.cityofchicago.org). The original data was summarized using the Data Portal Filter by summing the daily duration of each trip, and then exported to a csv file. The summarized data is public and available [here](https://data.cityofchicago.org/Transportation/Divy_daily_duration/3hs6-p2qv).

```{r Load Data, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(forecast)

divvy <- read_csv("data/divvy_daily_duration.csv")

divvy$date <- mdy(divvy$`START TIME`)
divvy$`START TIME` <- NULL
divvy$duration <- divvy$`TRIP DURATION`
divvy$`TRIP DURATION` <- NULL
```

First we will look at the overall time series and examine its features. 

```{r fig_1, fig.cap="Divvy Bike Time Series"}
library(xts)

divvy_xts <- xts(divvy$duration, order.by = divvy$date)
plot(divvy_xts, main= "Divvy daily ridership duration", ylab="Hours per day")
```

I am using the extended time series object in R (xts), since the data has two levels of seasonality: weekly and yearly. 

To explore annual trends we can combine the data into a weekly and monthly series.

```{r}
divvy_w <- divvy %>% group_by(week = as.POSIXct(cut(date, "week"))) %>% summarise(weekly_rides = sum(duration))
divvy_m <- divvy %>% group_by(month = as.POSIXct(cut(date, "month"))) %>% summarise(monthly_rides = sum(duration))
```


Let's split out the latter half of 2016 as a test set so that we can examine how well our models predict future Divvy bick rider duration. 

```{r}
divvy_d_test <- divvy_xts[20160701/20161231]
divvy_w_test <- divvy_w %>% filter(week >= "2016-07-01")
divvy_m_test <- divvy_m %>% filter(month >= "2016-07-01")

divvy_d_train <- divvy_xts[2013/20160701]
divvy_w_train <- divvy_w %>% filter(week < "2016-07-01")
divvy_m_train <- divvy_m %>% filter(month < "2016-07-01")

tail(divvy_m_train)
divvy_m_train <- xts(divvy_m_train$monthly_rides, order.by = divvy_m_train$month)

```

Let's first try modeling the longer term series with monthly data, first with an auto ETS damped model. 

```{r}
fit1 <- ets(divvy_m_train, damped = TRUE)
summary(fit1)
autoplot(fit1)
autoplot(forecast(fit1, h = 7))
```

Next, we will try exploring a seasonal Arima model. First, let's look at the ACF and PACF plots on the orininal series. 

```{r}
ggtsdisplay(divvy_m_train, main="Monthly Divvy Usage")
```

Using a Lag of 12 first to remove the seasonality.

```{r}
ggtsdisplay(diff(divvy_m_train, lag = 12))
```

Then a second differencing to remove autocorrelation from first lag. 

```{r}
ggtsdisplay(diff(diff(divvy_m_train, lag = 12)))
```

This now appears to be stationary. 

```{r}
fit2 <- Arima(divvy_m_train, order = c(0,1,1), seasonal = list(order = c(0,1,1), period = 12))
fit3 <- Arima(divvy_m_train, order = c(0,1,0), seasonal = list(order = c(0,1,1), period = 12))
fit4 <- Arima(divvy_m_train, order = c(0,1,1), seasonal = list(order = c(0,1,0), period = 12))
fit5 <- Arima(divvy_m_train, order = c(1,1,0), seasonal = list(order = c(0,1,0), period = 12))
fit2$aic
fit3$aic
fit4$aic
fit5$aic
```

The Arima model with the lowest AIC is an $ARIMA(1,1,0)(0,1,0)_{12}$

## Try Prophet on monthly data

```{r}
library(prophet)
divvy_m_prophet <- divvy_m
divvy_m_prophet$ds <- divvy_m_prophet$month
divvy_m_prophet$y <- divvy_m_prophet$monthly_rides

m <- prophet(divvy_m_prophet)

future <- make_future_dataframe(m, periods = 12)
tail(future)

forecast <- predict(m, future)

plot(m, forecast)
```

## Modeling daily Divvy durration within the year


Let's now try and model the 












